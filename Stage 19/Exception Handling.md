### Exception Handling in XSM

- code must start at memory address 1024(page 2)

a. **Illegal memory access** 
    - any address generated by the application lies outside its logical address space
    - This also occurs when the process tries to write into pages whose *Write access bit* is not set in page table
    - valid instruction should have logical page number inside [0, 512 * PTLR - 1]
    
b. **Illegal instruction**
    - an application tries to execute an instruction not belonging to the instruction set or when an operand / data in an instruction is not legal
    - *e.g. MOV 4, R0 or MOV IP, 4*

c. **Arithmetic exception**
    - when there is division/modulus by zero (e.g. DIV R0, 0)

d. **Page fault**
    - most significant exceptiion handling function
    - instruction contains an address whose logical page number is within the range 0 to PTLR - 1 & valid bit in the page table entry is set to 0

- First 3 exception handled by passing control to other priviliged mode OS routine to terminate the application & schedule other app's

- Page fault can occur during *instruction fetch* or *operand fetch*

- Page fault exception allows the OS to delay allocation of memory pages to a program in execution till the program acutally tries to access the page

- OS can set the valid bit of unallocated pages in the address space of the process to 0 & wait for the program to generate a page fault when & if the program tries to access the page

- the page fault handler an be designed to attach the required memory pages to the program (loading the page from the disk) so the program can resume execution

- this "lazy" allocation minimizes memory usage => more programs  in memory than usual
- technique is called **demand paging**

When the machine raises ans exception, 

1. IP is set to value 1024 & machine switches to privivliged mode

2. Machine sets several CPU registers with values that describe the cause of the exception
    a. **EIP** (Exception IP)
        - logical IP value of the user mode instruction that caused exception
    
    b. **EPN** (Exception Page Number)
        - only valid in the case of a page fault
        - logical page number that caused the page fault is stored

    c. **EC** (Exception cause)
        - indicates the cause of the exception
            0 - Page fault
            1 - Illegal instruction
            2 - Illegal memory access
            3 - Arithmetic exception
    
    d. **EMA** (Exception Memory address)
        - only valid in case of illegal memory access
        - illegal memory which was tried to be accesssed is stored
        - Either address is outside the range 0 - 512*(PTLR - 1) or a write attempted to a page which is read only